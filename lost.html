<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Catchy â€” Report Lost Item</title>

  <!-- Leaflet CSS for map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-sA+e2vYy2fRn1rHgG1sI6k6g8k0u7M2bMZQ1g2k+G6k=" crossorigin=""/>

  <style>
    body { font-family: system-ui, Arial; margin: 20px; color: #111; background:#0e1620; color:#ddd; }
    .container { max-width: 900px; margin: 0 auto; }
    label { display:block; margin-top:12px; font-weight:600; }
    input, textarea, button { width:100%; padding:10px; margin-top:6px; border-radius:6px; border:1px solid #444; background:#0b1120; color:#ddd; }
    #map { height: 320px; margin-top:10px; border-radius:8px; border:1px solid #333; }
    .small { width:auto; display:inline-block; margin-right:10px; }
    .progress { height:6px; background:#222; border-radius:4px; overflow:hidden; margin-top:6px; }
    .progress > div { height:100%; width:0%; background:#2ecc71; transition: width .2s; }
    .note { color:#aaa; font-size:13px; }
    .actions { margin-top:12px; display:flex; gap:10px; }
    .actions button { flex:1; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Report Lost Item</h1>
    <p class="note">Logged-in users only. Upload photos, pin locations on the map, or use voice to describe.</p>

    <form id="lostForm">
      <label>Item name</label>
      <input id="itemName" required placeholder="e.g. Black wallet, Samsung phone" />

      <label>Description (you can use voice)</label>
      <textarea id="description" rows="4" placeholder="Describe item, last seen details..."></textarea>
      <div style="margin-top:6px">
        <button id="startVoice" type="button" class="small">ðŸŽ¤ Voice</button>
        <span id="voiceStatus" class="note">Voice not started</span>
      </div>

      <label>When lost (date/time)</label>
      <input id="lostAt" type="datetime-local" />

      <label>Photos (you may choose multiple)</label>
      <input id="photos" type="file" accept="image/*" multiple />

      <div id="preview" style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap"></div>

      <label>Map â€” click to add pin(s)</label>
      <div id="map"></div>
      <div class="note">Click the map to add pin(s). Click a pin to remove it.</div>

      <div style="margin-top:10px">
        <label>Selected locations (lat,lng)</label>
        <textarea id="locations" readonly rows="2" placeholder="Map pins will appear here"></textarea>
      </div>

      <div style="margin-top:10px">
        <label>Privacy</label>
        <select id="privacy">
          <option value="public">Public (all users)</option>
          <option value="private">Only me</option>
        </select>
      </div>

      <div class="actions">
        <button id="submitBtn" type="submit">Submit Lost Report</button>
        <button id="clearMap" type="button">Clear Pins</button>
      </div>

      <div style="margin-top:10px">
        <div class="progress"><div id="uploadBar"></div></div>
        <div id="status" class="note"></div>
      </div>
    </form>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-pv1y0r5L+w3x0s4lq8Qf5wYc2bG8mP4n+v2Fv0s+0nI=" crossorigin=""></script>

  <!-- Firebase init + page logic -->
  <script type="module">
    import "/js/init-firebase.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { ref as sRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

    const auth = window.firebaseAuth;
    const db = window.firebaseDB;
    const storage = window.firebaseStorage;

    // --- UI references
    const lostForm = document.getElementById('lostForm');
    const photosInput = document.getElementById('photos');
    const preview = document.getElementById('preview');
    const uploadBar = document.getElementById('uploadBar');
    const statusEl = document.getElementById('status');
    const locationsEl = document.getElementById('locations');
    const startVoice = document.getElementById('startVoice');
    const voiceStatus = document.getElementById('voiceStatus');

    // check auth
    onAuthStateChanged(auth, user => {
      if (!user) {
        alert('Please sign in to create a report.');
        window.location.href = '/';
      }
    });

    // --- Leaflet map setup
    const map = L.map('map').setView([20.5937,78.9629], 5); // India-centered default
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      maxZoom: 19
    }).addTo(map);

    let pins = []; // { marker, latlng }
    function updateLocationsTextarea() {
      const arr = pins.map(p => `${p.latlng.lat.toFixed(6)},${p.latlng.lng.toFixed(6)}`);
      locationsEl.value = arr.join(' | ');
    }

    map.on('click', (e) => {
      const marker = L.marker(e.latlng, { draggable: true }).addTo(map);
      const p = { marker, latlng: e.latlng };
      pins.push(p);
      marker.on('click', ()=> {
        map.removeLayer(marker);
        pins = pins.filter(x => x.marker !== marker);
        updateLocationsTextarea();
      });
      marker.on('dragend', function(ev){
        p.latlng = ev.target.getLatLng();
        updateLocationsTextarea();
      });
      updateLocationsTextarea();
    });

    document.getElementById('clearMap').addEventListener('click', ()=>{
      pins.forEach(p => map.removeLayer(p.marker));
      pins = [];
      updateLocationsTextarea();
    });

    // --- Image preview
    photosInput.addEventListener('change', ()=> {
      preview.innerHTML = '';
      Array.from(photosInput.files).forEach(file => {
        const url = URL.createObjectURL(file);
        const img = document.createElement('img');
        img.src = url;
        img.style.height = '88px';
        img.style.objectFit = 'cover';
        img.style.borderRadius = '6px';
        preview.appendChild(img);
      });
    });

    // --- Voice to text (Web Speech)
    let recognition=null;
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRec();
      recognition.lang = 'en-US';
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.onstart = ()=> voiceStatus.textContent = 'Listening...';
      recognition.onend = ()=> voiceStatus.textContent = 'Stopped';
      recognition.onresult = (ev)=>{
        const txt = ev.results[0][0].transcript;
        document.getElementById('description').value += (document.getElementById('description').value ? ' ' : '') + txt;
      };
    } else {
      startVoice.disabled = true;
      voiceStatus.textContent = 'Voice not supported';
    }
    startVoice.addEventListener('click', ()=>{
      if (!recognition) return;
      try { recognition.start(); } catch(e){ console.warn(e); }
    });

    // --- Upload helper
    async function uploadFileAndGetURL(file, progressCallback) {
      const path = `reports/${Date.now()}_${file.name}`;
      const storageRef = sRef(storage, path);
      const uploadTask = uploadBytesResumable(storageRef, file);
      return new Promise((resolve, reject) => {
        uploadTask.on('state_changed', (snapshot) => {
          const pct = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
          progressCallback(pct);
        }, reject, async ()=>{
          const url = await getDownloadURL(uploadTask.snapshot.ref);
          resolve(url);
        });
      });
    }

    async function uploadAllFiles(files) {
      const urls = [];
      for (let i=0;i<files.length;i++){
        statusEl.textContent = `Uploading ${i+1} / ${files.length}...`;
        const url = await uploadFileAndGetURL(files[i], (pct)=>{
          uploadBar.style.width = `${pct}%`;
        });
        urls.push(url);
      }
      return urls;
    }

    // --- Submit form
    lostForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) { alert('Please sign in'); return; }

      const itemName = document.getElementById('itemName').value.trim();
      const description = document.getElementById('description').value.trim();
      const lostAt = document.getElementById('lostAt').value || new Date().toISOString();
      const privacy = document.getElementById('privacy').value;
      const files = photosInput.files;

      statusEl.textContent = 'Starting upload...';
      uploadBar.style.width = '0%';

      try {
        let uploadedURLs = [];
        if (files && files.length) {
          uploadedURLs = await uploadAllFiles(files);
        }

        const locs = pins.map(p => ({ lat: p.latlng.lat, lng: p.latlng.lng }));

        // create Firestore document
        const docRef = await addDoc(collection(db, 'reports'), {
          type: 'lost',
          userId: user.uid,
          userEmail: user.email || null,
          itemName,
          description,
          images: uploadedURLs,
          locations: locs,
          lostAt: lostAt,
          privacy,
          status: 'open',
          createdAt: serverTimestamp()
        });

        statusEl.textContent = 'Report saved. ID: ' + docRef.id;
        uploadBar.style.width = '100%';
        // redirect to history or dashboard
        setTimeout(()=> { window.location.href = '/dashboard.html'; }, 1200);

      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Error: ' + err.message;
      }
    });

  </script>
</body>
</html>
